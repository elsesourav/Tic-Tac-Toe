<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Tic Tac Toe with Twist</title>
   <style>
      body {
         font-family: Arial, sans-serif;
         display: flex;
         justify-content: center;
         align-items: center;
         height: 100vh;
      }

      table {
         border-collapse: collapse;
      }

      td {
         width: 60px;
         height: 60px;
         text-align: center;
         font-size: 24px;
         border: 1px solid #000;
         cursor: pointer;
      }
   </style>
</head>

<body>
   <table id="board">
      <tr>
         <td data-index="0"></td>
         <td data-index="1"></td>
         <td data-index="2"></td>
      </tr>
      <tr>
         <td data-index="3"></td>
         <td data-index="4"></td>
         <td data-index="5"></td>
      </tr>
      <tr>
         <td data-index="6"></td>
         <td data-index="7"></td>
         <td data-index="8"></td>
      </tr>
   </table>
   <script>
      const board = Array(9).fill(null);
      const humanPlayer = 'O';
      const aiPlayer = 'X';
      const maxMarks = 3; // Maximum number of marks per player
      const moveHistory = { 'O': [], 'X': [] };

      const boardElement = document.getElementById('board');
      boardElement.addEventListener('click', handleClick);

      function handleClick(event) {
         const index = event.target.dataset.index;
         if (board[index] || checkWinner(board)) return;
         makeMove(index, humanPlayer);
         if (!checkWinner(board) && !isBoardFull(board)) {
            const bestMove = getBestMove(board, aiPlayer);
            makeMove(bestMove, aiPlayer);
         }
      }

      function makeMove(index, player) {
         if (moveHistory[player].length >= maxMarks) {
            const oldestMove = moveHistory[player].shift();
            board[oldestMove] = null;
         }
         board[index] = player;
         moveHistory[player].push(index);
         renderBoard();
      }

      function renderBoard() {
         board.forEach((mark, index) => {
            boardElement.querySelector(`[data-index='${index}']`).textContent = mark;
         });
         const winner = checkWinner(board);
         if (winner) {
            setTimeout(() => alert(`${winner} wins!`), 10);
         } else if (isBoardFull(board)) {
            setTimeout(() => alert('Draw!'), 10);
         }
      }

      function checkWinner(board) {
         const winPatterns = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8],
            [0, 3, 6], [1, 4, 7], [2, 5, 8],
            [0, 4, 8], [2, 4, 6]
         ];
         for (const [a, b, c] of winPatterns) {
            if (board[a] && board[a] === board[b] && board[a] === board[c]) {
               return board[a];
            }
         }
         return null;
      }

      function isBoardFull(board) {
         return board.every(cell => cell);
      }

      function getBestMove(board, player) {

         if (moveHistory[player].length >= maxMarks) {
            const oldestMove = moveHistory[player].shift();
            board[oldestMove] = null;
         }
         board[index] = player;
         moveHistory[player].push(index);

         
         // 1. Try to win if possible
         for (let i = 0; i < board.length; i++) {
            if (!board[i]) {
               board[i] = aiPlayer;
               if (checkWinner(board) === aiPlayer) {
                  board[i] = null;
                  return i; // Take the winning move
               }
               board[i] = null;
            }
         }

         // 2. Block opponent's winning move
         for (let i = 0; i < board.length; i++) {
            if (!board[i]) {
               board[i] = humanPlayer;
               if (checkWinner(board) === humanPlayer) {
                  board[i] = null;
                  return i; // Block the opponent's winning move
               }
               board[i] = null;
            }
         }

         // 3. Use Minimax to evaluate the best move
         let bestScore = -Infinity;
         let bestMove;
         for (let i = 0; i < board.length; i++) {
            if (!board[i]) {
               board[i] = aiPlayer;
               const score = minimax(board, 0, false);
               board[i] = null;
               if (score > bestScore) {
                  bestScore = score;
                  bestMove = i;
               }
            }
         }
         return bestMove;
      }

      function minimax(board, depth, isMaximizing) {
         const winner = checkWinner(board);
         if (winner === aiPlayer) return 10 - depth;
         if (winner === humanPlayer) return depth - 10;
         if (isBoardFull(board)) return 0;

         if (isMaximizing) {
            let bestScore = -Infinity;
            for (let i = 0; i < board.length; i++) {
               if (!board[i]) {
                  board[i] = aiPlayer;
                  const score = minimax(board, depth + 1, false);
                  board[i] = null;
                  bestScore = Math.max(score, bestScore);
               }
            }
            return bestScore;
         } else {
            let bestScore = Infinity;
            for (let i = 0; i < board.length; i++) {
               if (!board[i]) {
                  board[i] = humanPlayer;
                  const score = minimax(board, depth + 1, true);
                  board[i] = null;
                  bestScore = Math.min(score, bestScore);
               }
            }
            return bestScore;
         }
      }
   </script>
</body>

</html>